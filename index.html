<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Call MVP - Manual</title>
    <style>
        body { margin:0; padding:0; height:100vh; background:#000; color:#fff; font-family:system-ui; display:flex; flex-direction:column; }
        .header { background:#075e54; padding:20px; text-align:center; font-size:22px; }
        .main { flex:1; padding:20px; text-align:center; }
        textarea { width:90%; height:150px; margin:20px 0; padding:10px; font-size:16px; }
        button { background:#25d366; color:white; border:none; padding:15px 30px; font-size:20px; border-radius:50px; margin:10px; }
        #status { margin:20px; font-size:18px; }
        audio { display:none; }
    </style>
</head>
<body>
    <div class="header">Voice Call MVP (Manual Copy-Paste)</div>
    <div class="main">
        <button id="start">Start (Get Mic)</button>
        <div id="role"></div>
        <textarea id="signal" placeholder="Paste signal here"></textarea>
        <button id="send">Create & Copy Signal</button>
        <button id="receive">Connect with Signal</button>
        <div id="status">Ready</div>
    </div>

    <audio id="remote" autoplay></audio>

    <script>
        const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let pc = null;
        let localStream = null;

        document.getElementById('start').onclick = async () => {
            localStream = await navigator.mediaDevices.getUserMedia({audio: true});
            document.getElementById('status').textContent = 'Mic ready – choose role';
            document.getElementById('role').innerHTML = `
                <p>Be Caller: <button id="caller">Create Offer</button></p>
                <p>Be Callee: Wait for offer, then <button id="callee">Create Answer</button></p>
            `;

            document.getElementById('caller').onclick = async () => {
                pc = new RTCPeerConnection(config);
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                setupEvents();
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                document.getElementById('signal').value = JSON.stringify(offer);
                document.getElementById('status').textContent = 'Copy this offer → send to friend';
            };

            document.getElementById('callee').onclick = async () => {
                const offerText = document.getElementById('signal').value;
                if (!offerText) return alert('Paste offer first');
                const offer = JSON.parse(offerText);
                pc = new RTCPeerConnection(config);
                localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
                setupEvents();
                await pc.setRemoteDescription(offer);
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                document.getElementById('signal').value = JSON.stringify(answer);
                document.getElementById('status').textContent = 'Copy this answer → send back to caller';
            };
        };

        document.getElementById('send').onclick = () => {
            document.getElementById('signal').select();
            document.execCommand('copy');
            document.getElementById('status').textContent = 'Copied! Send to friend';
        };

        document.getElementById('receive').onclick = async () => {
            const signalText = document.getElementById('signal').value;
            if (!signalText || !pc) return alert('Start and create signal first');
            const signal = JSON.parse(signalText);
            if (signal.type === 'answer') {
                await pc.setRemoteDescription(signal);
                document.getElementById('status').textContent = 'Connected!';
            }
        };

        function setupEvents() {
            pc.onicecandidate = e => {
                if (e.candidate) {
                    // In full version, send candidate automatically – here manual for simplicity
                    console.log('New ICE:', e.candidate);
                }
            };
            pc.ontrack = e => {
                document.getElementById('remote').srcObject = e.streams[0];
                document.getElementById('status').textContent = 'Connected – talk!';
            };
        }
    </script>
</body>
</html>        <h2>Incoming Call</h2>
        <div class="btns">
            <button id="decline">✖</button>
            <button id="accept">✔</button>
        </div>
    </div>

    <audio id="remote-audio" autoplay></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/sfx/preview/mixkit-classic-telephone-ring-1114.mp3" loop></audio>

    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        function generateCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        const myCode = generateCode();
        document.getElementById('my-code').textContent = myCode;

        const peer = new Peer(); // Auto-generates random ID
        let currentCall = null;

        peer.on('open', () => console.log('Ready'));

        // Incoming call
        peer.on('call', incomingCall => {
            currentCall = incomingCall;
            document.getElementById('incoming').style.display = 'flex';
            document.getElementById('ringtone').play();

            document.getElementById('decline').onclick = () => {
                incomingCall.close();
                hideIncoming();
            };

            document.getElementById('accept').onclick = () => {
                hideIncoming();
                navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                    incomingCall.answer(stream);
                    setupRemoteStream(incomingCall);
                });
            };
        });

        function setupRemoteStream(call) {
            call.on('stream', remoteStream => {
                document.getElementById('remote-audio').srcObject = remoteStream;
                document.getElementById('status').textContent = 'Connected!';
            });
            call.on('close', () => document.getElementById('status').textContent = 'Call ended');
        }

        function hideIncoming() {
            document.getElementById('incoming').style.display = 'none';
            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;
        }

        document.getElementById('call-btn').onclick = () => {
            const target = document.getElementById('target-code').value.trim();
            if (target.length !== 6 || target === myCode) {
                alert('Enter a valid different code');
                return;
            }

            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                const call = peer.call(target, stream); // Calls directly by code (we'll map code→peerID next)
                setupRemoteStream(call);
                document.getElementById('status').textContent = 'Calling...';
            }).catch(() => alert('Allow microphone access'));
        };
    </script>
</body>
              </html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#dc3545">
    <title>iNet | Secure PIN Calling</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .dialpad-btn:active { transform: scale(0.92); background-color: #f3f4f6; }
        .glass-morphism { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
        .pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
    </style>
</head>
<body class="bg-gray-50 h-screen flex flex-col overflow-hidden">

    <!-- Connection Status -->
    <div id="status-bar" class="bg-red-500 text-white text-xs text-center py-1 hidden">Connecting to server...</div>

    <!-- Header -->
    <header class="bg-slate-900 text-white p-4 flex justify-between items-center shrink-0">
        <div class="flex items-center gap-3">
            <div class="bg-red-600 w-8 h-8 rounded-lg flex items-center justify-center font-bold">i</div>
            <h1 class="text-lg font-semibold" id="app-title">iNet</h1>
        </div>
        <button onclick="ui.showContactForm()" class="text-xl">ï¼‹</button>
    </header>

    <!-- Main Screens -->
    <main class="flex-1 overflow-y-auto pb-24">
        
        <!-- Signup Screen -->
        <section id="screen-signup" class="h-full flex flex-col items-center justify-center p-8 text-center hidden">
            <div class="bg-red-600 w-24 h-24 rounded-3xl flex items-center justify-center text-white text-6xl font-light mb-8 shadow-xl">i</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Welcome to iNet</h2>
            <p class="text-gray-500 mb-8">Call anyone with a 6-digit PIN. No phone number or account required.</p>
            <button onclick="app.signup()" class="bg-red-600 text-white px-12 py-4 rounded-full font-bold text-lg shadow-lg active:scale-95 transition-transform">Get My PIN</button>
        </section>

        <!-- Recents Screen -->
        <section id="screen-recent" class="p-4 space-y-3 hidden">
            <div id="recent-list" class="space-y-3"></div>
            <div id="recent-empty" class="py-20 text-center text-gray-400">
                <p class="text-5xl mb-4">ðŸ•’</p>
                <p>No recent calls</p>
            </div>
        </section>

        <!-- Contacts Screen -->
        <section id="screen-contacts" class="p-4 space-y-4 hidden">
            <div class="bg-gradient-to-br from-red-500 to-red-700 rounded-2xl p-6 text-white shadow-lg">
                <p class="text-xs opacity-80 uppercase tracking-widest mb-1">My Personal PIN</p>
                <div class="text-4xl font-mono font-bold tracking-tighter" id="display-my-pin">------</div>
                <p class="text-[10px] mt-4 opacity-70">Share this PIN with friends so they can call you.</p>
            </div>
            <div id="contact-list" class="space-y-2"></div>
        </section>

    </main>

    <!-- Bottom Nav -->
    <nav id="bottom-nav" class="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 pb-6 glass-morphism hidden">
        <button onclick="ui.switchTab('recent')" class="flex flex-col items-center gap-1 text-gray-400 nav-link active" data-tab="recent">
            <span class="text-xl">ðŸ•’</span>
            <span class="text-[10px]">Recent</span>
        </button>
        <button onclick="ui.switchTab('contacts')" class="flex flex-col items-center gap-1 text-gray-400 nav-link" data-tab="contacts">
            <span class="text-xl">ðŸ‘¤</span>
            <span class="text-[10px]">Contacts</span>
        </button>
    </nav>

    <!-- Floating Dial Button -->
    <button id="fab-dial" onclick="ui.openDialpad()" class="fixed bottom-20 right-6 w-14 h-14 bg-red-600 text-white rounded-full shadow-2xl flex items-center justify-center text-2xl z-40 hidden">ðŸ“ž</button>

    <!-- Dialpad Overlay -->
    <div id="overlay-dialpad" class="fixed inset-0 bg-black/60 z-50 flex flex-col justify-end hidden">
        <div class="bg-white rounded-t-3xl p-6 animate-b-slide">
            <div class="text-center mb-6">
                <div class="text-4xl font-mono tracking-widest h-12 flex items-center justify-center" id="dial-display"></div>
            </div>
            <div class="grid grid-cols-3 gap-4 mb-8">
                <!-- Dialpad Buttons -->
                <button onclick="app.dial('1')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">1</button>
                <button onclick="app.dial('2')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">2</button>
                <button onclick="app.dial('3')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">3</button>
                <button onclick="app.dial('4')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">4</button>
                <button onclick="app.dial('5')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">5</button>
                <button onclick="app.dial('6')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">6</button>
                <button onclick="app.dial('7')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">7</button>
                <button onclick="app.dial('8')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">8</button>
                <button onclick="app.dial('9')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">9</button>
                <button class="h-16 rounded-full text-2xl opacity-0">*</button>
                <button onclick="app.dial('0')" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">0</button>
                <button onclick="app.backspace()" class="dialpad-btn h-16 rounded-full bg-gray-50 text-2xl">âŒ«</button>
            </div>
            <div class="flex gap-4">
                <button onclick="app.startCall('audio')" class="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold">Audio Call</button>
                <button onclick="app.startCall('video')" class="flex-1 bg-red-600 text-white py-4 rounded-xl font-bold">Video Call</button>
                <button onclick="ui.closeDialpad()" class="px-6 bg-gray-200 rounded-xl">âœ•</button>
            </div>
        </div>
    </div>

    <!-- Active Call Screen -->
    <div id="screen-call" class="fixed inset-0 bg-slate-900 z-[100] flex flex-col items-center justify-between p-12 text-white hidden">
        <div class="text-center mt-12">
            <div id="call-avatar" class="w-32 h-32 bg-red-600 rounded-full flex items-center justify-center text-5xl font-bold mx-auto mb-6">?</div>
            <h2 id="call-name" class="text-2xl font-bold mb-1">Unknown</h2>
            <p id="call-pin" class="text-gray-400 font-mono tracking-widest mb-4">------</p>
            <div id="call-timer" class="text-green-400 font-mono text-xl">00:00</div>
            <p id="call-status" class="text-sm text-gray-500 uppercase tracking-widest mt-2">Connecting...</p>
        </div>

        <!-- Video Feeds -->
        <div id="video-ui" class="relative w-full aspect-video bg-black rounded-2xl overflow-hidden hidden">
            <video id="remote-video" class="w-full h-full object-cover" autoplay playsinline></video>
            <video id="local-video" class="absolute top-4 right-4 w-1/4 aspect-video bg-gray-800 rounded-lg border border-white/20 object-cover" autoplay playsinline muted></video>
        </div>

        <div class="flex gap-8 mb-8">
            <button onclick="app.toggleMute()" id="btn-mute" class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center text-2xl">ðŸŽ¤</button>
            <button onclick="app.hangup()" class="w-20 h-20 rounded-full bg-red-600 flex items-center justify-center text-3xl shadow-xl">âœ•</button>
            <button onclick="app.toggleSpeaker()" class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center text-2xl">ðŸ”Š</button>
        </div>
    </header>

    <!-- Audio elements -->
    <audio id="remote-audio" autoplay></audio>

    <script>
        /**
         * APPLICATION CONFIGURATION
         */
        const CONFIG = {
            API_BASE: 'https://emltechstudio-inet.hf.space',
            ICE_SERVERS: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        const state = {
            myPin: localStorage.getItem('iNet_pin'),
            contacts: JSON.parse(localStorage.getItem('iNet_contacts') || '[]'),
            recent: JSON.parse(localStorage.getItem('iNet_recent') || '[]'),
            currentCall: null,
            pc: null,
            localStream: null,
            isMuted: false,
            pollTimer: null,
            dialString: ''
        };

        /**
         * APP LOGIC
         */
        const app = {
            async init() {
                if (!state.myPin) {
                    ui.showScreen('signup');
                } else {
                    ui.showScreen('recent');
                    document.getElementById('display-my-pin').innerText = state.myPin;
                    this.startCheckingForIncoming();
                }
                ui.renderRecent();
                ui.renderContacts();
            },

            async signup() {
                try {
                    const res = await fetch(`${CONFIG.API_BASE}/api/signup`, { method: 'POST' });
                    const data = await res.json();
                    if (data.success) {
                        state.myPin = data.pin;
                        localStorage.setItem('iNet_pin', data.pin);
                        this.init();
                    }
                } catch (e) {
                    alert('Server connection failed. Is the backend running?');
                }
            },

            dial(val) {
                if (state.dialString.length < 6) {
                    state.dialString += val;
                    ui.updateDialDisplay();
                }
            },

            backspace() {
                state.dialString = state.dialString.slice(0, -1);
                ui.updateDialDisplay();
            },

            async startCall(type, targetPin = null) {
                const pin = targetPin || state.dialString;
                if (pin.length !== 6) return;
                
                ui.closeDialpad();
                ui.showCallScreen(pin, type);
                
                try {
                    // 1. Get Media
                    state.localStream = await navigator.mediaDevices.getUserMedia({
                        audio: true,
                        video: type === 'video'
                    });
                    
                    if (type === 'video') {
                        document.getElementById('video-ui').classList.remove('hidden');
                        document.getElementById('local-video').srcObject = state.localStream;
                    }

                    // 2. PeerConnection Setup
                    state.pc = new RTCPeerConnection(CONFIG.ICE_SERVERS);
                    state.localStream.getTracks().forEach(t => state.pc.addTrack(t, state.localStream));
                    
                    state.pc.ontrack = (e) => {
                        if (type === 'video') document.getElementById('remote-video').srcObject = e.streams[0];
                        else document.getElementById('remote-audio').srcObject = e.streams[0];
                        document.getElementById('call-status').innerText = 'Connected';
                    };

                    // 3. Signaling - Create Offer
                    const offer = await state.pc.createOffer();
                    await state.pc.setLocalDescription(offer);

                    // 4. Send to server
                    const res = await fetch(`${CONFIG.API_BASE}/api/call`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            caller_pin: state.myPin,
                            callee_pin: pin,
                            offer: offer,
                            call_type: type
                        })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        state.currentRoom = data.room_code;
                        this.startPolling(data.room_code);
                    } else {
                        throw new Error(data.error);
                    }

                } catch (e) {
                    console.error(e);
                    this.hangup();
                    alert('Call failed: ' + e.message);
                }
            },

            async startPolling(roomCode) {
                state.pollTimer = setInterval(async () => {
                    const res = await fetch(`${CONFIG.API_BASE}/api/poll/${roomCode}/${state.myPin}`);
                    const data = await res.json();
                    
                    if (data.hangup) this.hangup();

                    if (data.signals) {
                        for (let signal of data.signals) {
                            if (signal.type === 'answer') {
                                await state.pc.setRemoteDescription(new RTCSessionDescription(signal.data));
                            } else if (signal.type === 'ice') {
                                await state.pc.addIceCandidate(new RTCIceCandidate(signal.data));
                            }
                        }
                    }
                }, 2000);
            },

            startCheckingForIncoming() {
                setInterval(async () => {
                    if (state.currentRoom) return;
                    try {
                        const res = await fetch(`${CONFIG.API_BASE}/api/incoming/${state.myPin}`);
                        const data = await res.json();
                        if (data.incoming) {
                            if (confirm(`Incoming ${data.call_type} call from ${data.caller_pin}. Accept?`)) {
                                this.answerCall(data);
                            } else {
                                fetch(`${CONFIG.API_BASE}/api/decline`, {
                                    method: 'POST',
                                    headers: {'Content-Type':'application/json'},
                                    body: JSON.stringify({room_code: data.room_code, pin: state.myPin})
                                });
                            }
                        }
                    } catch(e) {}
                }, 4000);
            },

            async answerCall(callData) {
                ui.showCallScreen(callData.caller_pin, callData.call_type);
                state.currentRoom = callData.room_code;
                
                state.localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: callData.call_type === 'video'
                });

                state.pc = new RTCPeerConnection(CONFIG.ICE_SERVERS);
                state.localStream.getTracks().forEach(t => state.pc.addTrack(t, state.localStream));
                
                state.pc.ontrack = (e) => {
                    if (callData.call_type === 'video') {
                        document.getElementById('video-ui').classList.remove('hidden');
                        document.getElementById('remote-video').srcObject = e.streams[0];
                    }
                    document.getElementById('remote-audio').srcObject = e.streams[0];
                };

                await state.pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
                const answer = await state.pc.createAnswer();
                await state.pc.setLocalDescription(answer);

                await fetch(`${CONFIG.API_BASE}/api/answer`, {
                    method: 'POST',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({
                        room_code: callData.room_code,
                        answer: answer,
                        callee_pin: state.myPin
                    })
                });

                this.startPolling(callData.room_code);
            },

            hangup() {
                if (state.pollTimer) clearInterval(state.pollTimer);
                if (state.pc) state.pc.close();
                if (state.localStream) state.localStream.getTracks().forEach(t => t.stop());
                
                if (state.currentRoom) {
                    fetch(`${CONFIG.API_BASE}/api/hangup`, {
                        method: 'POST',
                        headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({room_code: state.currentRoom, pin: state.myPin})
                    });
                }

                state.pc = null;
                state.localStream = null;
                state.currentRoom = null;
                ui.hideCallScreen();
            }
        };

        /**
         * UI CONTROLLER
         */
        const ui = {
            showScreen(id) {
                ['signup', 'recent', 'contacts'].forEach(s => document.getElementById(`screen-${s}`).classList.add('hidden'));
                document.getElementById(`screen-${id}`).classList.remove('hidden');
                
                if (id !== 'signup') {
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    document.getElementById('fab-dial').classList.remove('hidden');
                }
            },

            switchTab(tab) {
                this.showScreen(tab);
                document.querySelectorAll('.nav-link').forEach(l => {
                    l.classList.remove('text-red-600');
                    if (l.dataset.tab === tab) l.classList.add('text-red-600');
                });
            },

            openDialpad() {
                state.dialString = '';
                this.updateDialDisplay();
                document.getElementById('overlay-dialpad').classList.remove('hidden');
            },

            closeDialpad() {
                document.getElementById('overlay-dialpad').classList.add('hidden');
            },

            updateDialDisplay() {
                document.getElementById('dial-display').innerText = state.dialString || '------';
            },

            showCallScreen(pin, type) {
                const screen = document.getElementById('screen-call');
                screen.classList.remove('hidden');
                document.getElementById('call-pin').innerText = pin;
                document.getElementById('call-avatar').innerText = pin[0];
                document.getElementById('call-status').innerText = 'Dialing...';
            },

            hideCallScreen() {
                document.getElementById('screen-call').classList.add('hidden');
            },

            renderRecent() {
                const container = document.getElementById('recent-list');
                const empty = document.getElementById('recent-empty');
                if (state.recent.length === 0) {
                    empty.classList.remove('hidden');
                    container.innerHTML = '';
                } else {
                    empty.classList.add('hidden');
                    container.innerHTML = state.recent.map(r => `
                        <div class="bg-white p-4 rounded-xl shadow-sm flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center font-bold">${r.pin[0]}</div>
                                <div>
                                    <p class="font-bold">${r.pin}</p>
                                    <p class="text-[10px] text-gray-400">${new Date(r.time).toLocaleString()}</p>
                                </div>
                            </div>
                            <span class="text-xs ${r.type === 'incoming' ? 'text-green-500' : 'text-blue-500'} uppercase">${r.type}</span>
                        </div>
                    `).join('');
                }
            },

            renderContacts() {
                const container = document.getElementById('contact-list');
                container.innerHTML = state.contacts.map(c => `
                    <div onclick="app.startCall('audio', '${c.pin}')" class="bg-white p-4 rounded-xl flex items-center justify-between active:bg-gray-50">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-red-100 text-red-600 rounded-full flex items-center justify-center font-bold">${c.name[0]}</div>
                            <div>
                                <p class="font-bold">${c.name}</p>
                                <p class="text-xs text-gray-400">${c.pin}</p>
                            </div>
                        </div>
                        <div class="text-gray-300">ðŸ“ž</div>
                    </div>
                `).join('');
            },

            showContactForm() {
                const name = prompt('Contact Name:');
                const pin = prompt('6-Digit PIN:');
                if (name && pin && pin.length === 6) {
                    state.contacts.push({ name, pin });
                    localStorage.setItem('iNet_contacts', JSON.stringify(state.contacts));
                    this.renderContacts();
                }
            }
        };

        // Start
        app.init();
    </script>
</body>
</html>

